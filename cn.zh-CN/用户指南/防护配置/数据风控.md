# 数据风控 {#concept_dcf_3hl_l2b .concept}

数据风控帮助您防御网站关键业务（如注册、登录、活动、论坛）中可能发生的欺诈行为。

## 功能描述 {#section_gnl_jhl_l2b .section}

数据风控基于阿里云的大数据能力，通过业内领先的风险决策引擎，结合人机识别技术，防止各类场景的关键业务欺诈行为。您只需将业务接入WAF即可使用数据风控功能，轻松获取风控能力，且无需在服务器或客户端进行任何改造。

数据风控支持防护的场景包括但不限于以下内容：

-   垃圾注册
-   短信验证码滥刷
-   撞库、暴力破解
-   恶意抢购、秒杀、薅羊毛、抢红包
-   机器人抢票、刷票、恶意投票
-   垃圾消息

**说明：** 数据风控仅适用于网页/H5环境，原生App业务防护请使用爬虫风险管理提供的[App增强防护SDK方案](../../../../../cn.zh-CN/用户指南/防护配置/App增强防护SDK/方案概述.md#)。

**说明：** 对于按量付费的WAF实例，您必须在功能与规格中启用**数据风控**，才能使用该功能。具体操作请参考[功能与规格配置](cn.zh-CN/用户指南/设置/功能与规格配置（按量付费模式）.md#)。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377074_zh-CN.png)

## 功能原理 {#section_sgf_5d3_4gb .section}

数据风控的工作流程如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377075_zh-CN.jpg)

关于接入数据风控的应用场景示例和实际效果，查看[应用示例](cn.zh-CN/用户指南/防护配置/数据风控.md#section_znl_jhl_l2b)。

## 操作步骤 {#section_lnl_jhl_l2b .section}

参照以下步骤，启用并配置数据风控：

**说明：** 执行以下操作前，请确保已将网站接入WAF进行防护。具体操作请参考[业务接入WAF配置](cn.zh-CN/用户指南/接入WAF/业务接入WAF配置.md#)。

1.  登录[云盾Web应用防火墙控制台](https://yundun.console.aliyun.com/?p=waf)。
2.  前往**管理** \> **网站配置**页面，并在页面上方选择WAF所在地区（中国大陆、海外地区）。
3.  选择要操作的域名，单击其操作列下的**防护配置**。
4.  打开**数据风控**状态开关并确认开启。

    **说明：** 启用数据风控功能后，WAF将在您网站的所有（或指定的）页面中插入JS插件用于安全防护，页面响应内容将以非gzip压缩方式进行传输。即使您的网站配置使用的是非标端口访问，配置数据风控也无需进行额外配置。关于如何指定JS插入页面，参考[指定JS插入页面](#)。

5.  选择防护**模式**：

    -   **预警**：识别到业务攻击时，只记录风险日志、不进行拦截，可通过业务风控报表查看详细风险情况。
    -   **防护**：识别到业务攻击时，用户将被重定向至验证页面进行二次验证。
    **说明：** 默认使用预警模式，数据风控不会对任何请求进行拦截，但依然会在静态页面中插入JS脚本分析客户端行为。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377077_zh-CN.png)

6.  单击**前去配置**，添加防护请求或指定JS插入页面。
    -   添加防护请求
        1.  在**防护请求**页签下，单击**新增防护请求**。

            ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/155046883738854_zh-CN.png)

        2.  在新增防护请求对话框，指定**防护请求URL**。

            ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377079_zh-CN.png)

            **什么是防护请求URL**

            防护请求URL指执行业务动作的接口地址，而不是页面本身的URL地址。

            例如，下图所示注册页面本身的URL地址为`www.abc.com/new_user`，获取验证码按钮对应的业务接口地址是`www.abc.com/getsmscode`，注册按钮对应的业务接口地址是`www.abc.com/register.do`。

            ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377080_zh-CN.png)

            这种情况下，您应该为获取验证码按钮的接口地址`www.abc.com/getsmscode`和注册按钮对应的接口地址`www.abc.com/register.do`分别添加防护请求，并设置为防护请求URL，防止验证码的短信接口被刷和垃圾注册风险。

            如果将注册页面地址`www.abc.com/new_user`设置为防护请求URL，当正常用户访问该页面时也将收到滑块验证提示，影响用户体验。

            **防护请求URL注意事项**

            -   防护请求URL必须精确到实际请求URL，不支持模糊匹配。

                例如，将`www.test.com/test`设置为防护请求URL，则数据风控只匹配test路径的访问请求，不会匹配test路径下所有页面的访问请求。

            -   数据风控支持对网页目录进行防护。

                例如，您将防护请求URL设置为`www.abc.com/book/*`，即可对`www.abc.com/book`路径下所有页面的请求实现数据风控防护。但是，不建议您为全站配置防护。假如设置`www.abc.com/*`为防护请求URL，将导致用户访问网站首页时也需要通过滑块验证，影响用户体验。

            -   直接请求数据风控已防护的URL一定会触发滑块验证。因此，请确保所配置的防护请求URL在正常情况下不会被用户直接请求，即正常用户通常需要经过一系列的前置访问后才会请求该URL地址。
            -   直接调用API接口的场景不适合使用数据风控进行防护。由于API调用是直接发起的机器行为，无法通过数据风控的人机识别验证。但是，对于正常用户单击页面中的某按钮调用API接口的情况，可以通过数据风控功能进行防护。
        3.  单击**确认**。

            防护请求添加成功后，10分钟左右生效。

    -   指定JS插入页面

        由于部分页面前端代码与数据风控的JavaScript脚本可能存在兼容性问题。如果遇到此类问题，可通过指定页面插入JS功能仅添加部分页面进行安全防护。

        **说明：** 仅在部分页面插入JS插件时，数据风控将可能无法获取完整的用户访问行为，并对最终的防护效果产生影响。

        1.  在JS插入页面页签下，单击**指定页面插入JS**。

            ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/155046883738852_zh-CN.png)

        2.  单击**添加页面**。

            **说明：** 最多可以添加20个页面地址。

        3.  在添加URL对话框中，输入要插入JS的页面地址（以"/"开头），单击**确认**。

            ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/155046883738853_zh-CN.png)

            数据风控将仅在您所添加的URL路径下的页面中插入JS插件。


启用数据风控后，您还可以使用WAF的全量日志功能查看防护结果。关于日志示例，参考[查看防护结果](#section_e4l_jhl_l2b)。

## 数据风控应用示例 {#section_znl_jhl_l2b .section}

阿里云用户小白在互联网上搭建网站业务，网站域名是`www.abc.com`，普通用户可以通过`www.abc.com/register.html`注册成为网站会员。

近来，小白发现存在黑客通过一些恶意脚步频繁提交注册请求，并注册大量垃圾账户来参与网站的抽奖活动。所提交的请求与正常用户请求相似度很高，且请求频率不高，传统的CC攻击防护功能难以分辨出这些恶意请求。

于是，小白将网站业务接入WAF并为`www.abc.com`域名开启数据风控功能。小白当前最关心的注册业务的请求URL是`www.abc.com/register.html`，因此将该URL设置为防护请求URL。

防护配置生效后：

-   数据风控通过在所有页面中插入的JS插件，观察并分析每一个访问`www.abc.com`网站域名（包括首页及其子路径）的用户的各种行为，判断是否存在异常。同时，结合阿里云的大数据信誉库判断访问源IP是否存在风险。
-   当用户向`www.abc.com/register.html`地址提交注册请求时，WAF将基于该用户自开始访问该网站，到提交注册请求间的所有行为和征信特征来判断用户是否可疑。例如，如果用户没有任何前置操作直接提交注册请求，则可基本判断该请求为可疑请求。
    -   当数据风控判断该请求为可疑请求，或者该访问源IP曾有不良记录，将通过滑块验证的方式验证用户身份。只有通过验证的用户，才能继续进行注册。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688377082_zh-CN.png)

        -   如果通过滑块验证方式可疑（例如，使用脚本模仿真人滑动过程等），数据风控将继续通过其它方式再次进行验证，直到验证通过且通过方式可信。
        -   如果无法通过验证，数据风控将阻断该请求。
    -   如果基于之前的行为，数据风控判断该请求来自正常用户，则该用户在注册过程中将无任何感知。

整个过程中，由于数据风控是针对整个网站域名（`www.abc.com`）开启的，**数据风控需要对该域名下的所有页面插入JS插件来判断用户行为是否可信**。而真正的防护和验证，仅针对`www.abc.com/register.html`注册接口URL生效，只有在提交注册请求时数据风控才会对请求进行干涉。

## 查看防护结果 {#section_e4l_jhl_l2b .section}

您可以使用WAF的[全量日志查询](cn.zh-CN/用户指南/防护统计/全量日志查询.md#)功能来排查数据风控的监控和拦截情况。例如，

-   通过数据风控验证的日志情况。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688387083_zh-CN.png)

    正常用户经过数据风控验证的访问请求URL将包含一个以ua开头的参数，请求会被WAF转发回源站，源站服务器正常响应该请求。

-   被数据风控拦截的日志情况。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688387084_zh-CN.png)

    如果直接请求业务接口URL，一般不会包含以ua开头的参数（或带有伪造的ua参数），这类请求将被WAF拦截，且请求日志中无源站响应信息。


因此，您可以使用[全量日志](https://yundun.console.aliyun.com/?p=waf#/waf/main/business/log)功能，在**高级搜索** \> **URL关键字**中配置启用数据风控的接口，来排查数据风控的监控和拦截情况。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15568/15504688387085_zh-CN.png)

