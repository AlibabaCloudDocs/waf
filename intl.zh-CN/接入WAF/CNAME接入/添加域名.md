# 添加域名

本文介绍了开通Web应用防火墙服务后，如何通过CNAME接入的方式为网站域名开启Web应用防火墙防护。

-   已开通Web应用防火墙服务，且当前实例支持接入的域名数量（包括一级域名数量和总域名数量）未超过限制。

    **说明：** 支持接入的域名数量由Web应用防火墙的实例规格和扩展域名包数量决定。更多信息，请参见[扩展域名包](/intl.zh-CN/产品定价/开通WAF/扩展域名包.md)。

-   接入中国内地的Web应用防火墙服务时，域名必须已完成中华人民共和国工业和信息化部ICP备案。

CNAME接入支持以下两种接入方式：

-   [自动添加网站](#section_06w_k6n_iiw)：Web应用防火墙自动读取当前阿里云账号关联的域名资产信息，您只需从**域名一键接入**页面选择需要接入的域名和网络协议类型，即可自动添加网站信息，包括网站域名、服务器地址、80和443标准协议端口，并自动修改域名的DNS解析。

    **说明：** 自动修改域名DNS解析需要执行添加域名的云账号具有操作云解析DNS的权限，否则自动修改域名解析会失败。这种情况下，您可以在自动添加网站后手动修改域名DNS解析。

-   [手动添加网站](#section_i0l_fp0_t66)：如果要添加的域名不支持自动添加，您可以手动添加要防护的网站信息，例如域名、网络协议、服务器地址、服务器端口等（引导Web应用防火墙转发正常Web请求到业务服务器），并手动修改域名的DNS解析，将网站的Web请求转发到Web应用防火墙进行安全清洗。

## 自动添加网站

在添加网站时，如果您的阿里云账号下存在满足条件的网站域名，则会出现**域名一键接入**页面，您可以直接选择要添加的网站，完成自动添加。

支持自动添加的网站域名仅包含云解析DNS中配置生效的网站域名。

**操作步骤**

1.  登录[Web应用防火墙控制台](https://yundun.console.aliyun.com/?p=waf)。

2.  在顶部菜单栏，选择Web应用防火墙实例的资源组和地域（**中国内地**、**海外地区**）。

3.  在左侧导航栏，单击**资产中心** \> **网站接入**。

4.  在**网站接入**页面，单击**添加域名**。

5.  在**域名一键接入**页面，从域名列表选择要添加的**域名**和**协议类型**，并单击**立即自动添加网站**。

    **说明：** 只有当存在满足条件的域名时，**域名一键接入**页面才会出现。如果**域名一键接入**没有出现，建议您手动添加网站。更多信息，请参见[添加域名配置向导](#step_81i_fn8_dsd)。

    ![域名一键接入](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/9835649951/p96929.png)

    如果域名使用HTTPS协议，则在选中**https**协议类型后，必须先完成证书验证才可以添加网站。

    验证证书的操作步骤如下：

    1.  选中某个域名和**https**协议类型后，单击域名**HTTPS证书**列的**验证证书**。

    2.  在**验证证书**对话框，选择一种**上传方式**上传HTTPS证书。

        具体操作请参见[上传HTTPS证书](#step5)。

    3.  完成HTTPS证书上传后，单击**确定**。

        -   如果证书验证顺利通过，您可以单击**立即自动添加网站**。
        -   如果证书验证失败，请根据错误提示（例如**证书与密钥不匹配**）重新验证证书，直到验证通过。
    Web应用防火墙将自动添加网站信息，包括网站域名、服务器地址、80和443标准协议端口，并自动修改域名的DNS解析。

    **说明：** 如果您需要添加80和443以外的端口，建议您在自动添加网站后，手动编辑域名进行调整。更多信息，请参见[相关操作](#section_l50_3ox_mix)。

    可能出现的异常结果及后续操作：

    -   **域名添加成功，但需要手动接入DNS**

        可能原因：执行添加域名的云账号不具有操作云解析DNS的权限、上传的HTTPS证书与网站域名不匹配。

        **说明：** 网站支持**https**协议且证书验证通过的情况下，如果上传的证书与网站不匹配，则证书检测失败，不会自动修改DNS解析。这种情况下，您必须重新上传合法、正确的证书再手动修改DNS。更多信息，请参见[上传HTTPS证书](#section_jo2_hwu_mbj)。

        单击**手动接入DNS**，根据**手动修改**对话框的操作引导，完成DNS修改。更多信息，请参见[修改域名DNS](/intl.zh-CN/接入WAF/CNAME接入/修改域名DNS.md)。

    -   **当前已达到主域名个数限制**

        单击**扩展域名包**，查看购买扩展域名包的操作引导。根据需要购买扩展域名包后，再尝试添加域名。

    -   **该域名未检测到ICP备案信息**

        接入中国内地的Web应用防火墙服务时，如果当前域名未通过ICP备案，则自动添加会提示失败。建议您先完成ICP备案再尝试添加域名。更多信息，请参见[ICP备案流程概述]()。


## 手动添加网站

1.  登录[Web应用防火墙控制台](https://yundun.console.aliyun.com/?p=waf)。

2.  在顶部菜单栏，选择Web应用防火墙实例的资源组和地域（**中国内地**、**海外地区**）。

3.  在左侧导航栏，单击**资产中心** \> **网站接入**。

4.  在**网站接入**页面，单击**添加域名**。

5.  在**域名一键接入**页面，单击**手动添加其他网站**。

    **说明：** 只有当存在满足条件的域名时（具体请参见[自动添加网站](#section_06w_k6n_iiw)），**域名一键接入**页面才会出现。如果**域名一键接入**没有出现，请忽略该步骤。

6.  根据**添加域名**配置向导完成相关任务。

    1.  **填写网站信息**。

        ![填写网站信息](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/0935649951/p66025.png)

        |参数|说明|
        |--|--|
        |**域名**|输入要防护的域名。         -   支持使用精确域名（例如`www.aliyun.com`）和泛域名（例如`*.aliyun.com`）格式。
            -   使用泛域名后，Web应用防火墙将自动匹配该泛域名对应的所有子域名。
            -   如果同时存在泛域名和精确域名配置，则精确域名的转发规则和防护策略优先生效。
        -   暂不支持添加`.edu`域名。如果您需要添加`.edu`域名，请提交工单联系售后技术支持。 |
        |**防护资源**（仅适用于独享版）|接入独享版Web应用防火墙服务时，选择要使用的防护资源类型。 **说明：** 仅当您的WAF实例为独享版时，该页面才会展示**防护资源**选项。

可选值：

        -   **公共集群**：默认选择。
        -   **独享集群**：独享集群支持定制化业务需求。更多信息，请参见[设置独享集群](/intl.zh-CN/系统管理/设置独享集群.md)。 |
        |**协议类型**|选择网站使用的网络协议类型。可选值：         -   **HTTP**
        -   **HTTPS**：如果网站支持HTTPS加密认证，请选择**HTTPS**协议并在添加域名后上传域名的证书和私钥文件。更多信息，请参见[上传HTTPS证书](#section_jo2_hwu_mbj)。

选中**HTTPS**协议后，将显示**高级设置**折叠菜单。

![HTTPS ](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/0935649951/p7688.png)

**高级设置**支持以下功能：

            -   **开启HTTPS的强制跳转**：开启后，网站的HTTP请求都强制转换为HTTPS，且默认跳转到443端口。开启HTTPS强制跳转前必须先取消HTTP协议。

如果您需要强制客户端使用HTTPS请求访问网站，提高安全性，则可以开启该功能。

**说明：** 请确保网站支持HTTPS业务再开启该功能。开启该功能后，部分浏览器将被强制设置为使用HTTPS请求访问网站。

            -   **开启HTTP回源**：开启后，Web应用防火墙使用HTTP协议发送回源请求，默认回源端口是80。

开启HTTP回源可以在无需改动源站服务器的前提下，通过Web应用防火墙实现HTTPS访问，帮助降低网站的负载损耗。如果您的网站不支持HTTPS回源，请务必开启该功能。

        -   **HTTP2.0**：仅对企业版和旗舰版Web应用防火墙实例开放，且必须先选中**HTTPS**协议才支持使用。 |
        |**服务器地址**|设置网站的源站服务器地址，支持**IP**地址格式和**其他**格式。完成接入后，Web应用防火墙将过滤后的访问请求转发到此处设置的服务器地址。         -   **IP**地址格式：填写源站的公网IP地址。

多个IP地址间使用英文逗号（,）分隔。最多支持添加20个源站IP。不支持换行。

**说明：** 如果设置了多个IP地址，Web应用防火墙将在这些地址间自动进行健康检查和负载均衡。

            -   如果源站在阿里云，一般填写ECS的公网IP地址。
            -   当ECS前面有SLB时，则填写SLB的公网IP地址。
            -   当源站在阿里云外的IDC机房或者其他云服务商时，建议您PING域名查询域名的公网IP地址，再填写域名的公网IP地址。
        -   **其他**格式：填写服务器回源域名，例如对象存储OSS的CNAME等。

服务器回源域名不应和要防护的网站域名相同。

**说明：** 如果您的源站服务器地址为OSS域名，则完成网站接入后，您必须前往OSS控制台中为该OSS域名绑定自定义域名，具体操作请参见[绑定自定义域名](/intl.zh-CN/控制台用户指南/存储空间管理/管理域名/绑定自定义域名.md)。 |
        |**服务器端口**|设置网站使用的转发服务端口。 Web应用防火墙通过此处设置的端口为网站提供流量的接入与转发服务，网站域名的业务流量只通过已设置的服务端口进行转发。对于未设置的端口，Web应用防火墙不会转发任何该端口的访问请求流量到源站服务器，因此这些端口的启用不会对源站服务器造成任何安全威胁。

**说明：** 网站信息中设置的**协议类型**和**服务器端口**必须是源站服务器提供Web业务的协议和端口，不支持端口转换。例如，源站服务器提供Web服务的是80端口HTTP协议，域名配置也必须是一致的，设置其他端口则无法正常转发。

默认端口：

        -   **HTTP 80**：选中HTTP协议后默认设置。
        -   **HTTPS 443**：选中HTTPS协议后默认设置。

**说明：** HTTP2.0协议的端口与HTTPS协议的端口保持一致。

自定义端口：单击**自定义**，分别设置HTTP和HTTPS协议自定义端口。

![自定义端口](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/0935649951/p97012.png)

单击**查看可选范围**可以查询所有支持使用的端口。多个端口间使用英文逗号（,）分隔。

**说明：**

        -   Web应用防火墙旗舰版和独享版实例最多支持接入50个不同的服务器端口（包含80、8080、443、8443端口在内）；企业版和高级版实例最多支持接入10个服务器端口（包含80、8080、443、8443端口在内）。
        -   关于公共集群支持的详细端口列表，请参见[支持的自定义端口范围](/intl.zh-CN/接入WAF/支持的自定义端口范围.md)。
        -   如果您要接入Web应用防火墙独享集群，则自定义端口仅支持从**独享集群设置**页面中设置的**服务器端口**范围中选择。更多信息，请参见[设置独享集群](/intl.zh-CN/系统管理/设置独享集群.md)。 |
        |**负载均衡算法**|设置了多个源站IP地址时，选择多源站IP间的负载均衡算法。可选值：         -   **IP hash**（默认）：将某个IP的请求定向到同一个源站服务器。

**说明：** 使用**IP hash**时，如果源站服务器的IP地址不够分散，可能会出现负载不均的情况。

        -   **轮询**：将所有请求轮流分配给源站服务器。
        -   **Least time**：通过智能DNS解析能力和升级后的Least-time回源算法，保证业务流量从接入防护节点到转发回源站服务器整个链路的时延最短。

**说明：** **Least time**仅在开通智能负载均衡后支持使用。更多信息，请参见[智能负载均衡接入能力](/intl.zh-CN/产品定价/开通WAF/智能负载均衡接入能力.md)。

设置生效后，Web应用防火墙将根据设置的负载均衡算法向多个源站IP分发回源请求，实现负载均衡。 |
        |**WAF前是否有七层代理（高防/CDN等）**|如果在Web应用防火墙前需要配置其他七层代理服务进行业务转发，请务必选择**是**，否则Web应用防火墙将无法获取访问网站的客户端真实IP。更多信息，请参见以下文档：         -   [同时部署WAF和DDoS高防](/intl.zh-CN/接入WAF/云产品接入WAF/同时部署WAF和DDoS高防.md)
        -   [同时部署WAF和CDN](/intl.zh-CN/接入WAF/云产品接入WAF/同时部署WAF和CDN.md)
如果在Web应用防火墙前不需要配置其他七层代理服务进行业务转发，请选择**否**。 |
        |**流量标记**|填写一个空闲的**Header字段名称**和自定义**Header字段值**，用来标识经过Web应用防火墙转发到源站的Web请求。 Web请求经过Web应用防火墙后，Web应用防火墙在请求中添加此处指定的字段和字段值，标识经转发的流量，方便您的后端服务统计信息，实现精准的源站保护（访问控制）、防护效果分析等。

**说明：** 如果Web请求中本身包含此处定义的头部字段，Web应用防火墙将用此处的设定值覆盖原Web请求中对应字段的内容。 |
        |**资源组**|从资源组列表中选择域名所属的资源组。 **说明：** 您可以使用资源管理服务创建资源组，根据业务部门、项目等维度对云资源进行分组管理。更多信息，请参见[创建资源组]()。 |

    2.  **修改DNS解析**。

        根据页面提示修改域名的DNS解析，将网站域名解析到Web应用防火墙进行安全清洗。更多信息，请参见[修改域名DNS](/intl.zh-CN/接入WAF/CNAME接入/修改域名DNS.md)。

    3.  **添加完成**。

        如果您的服务器正在使用除Web应用防火墙以外的防火墙服务，建议您将其关闭或将Web应用防火墙的IP地址加入其白名单，避免误拦截。更多信息，请参见[放行WAF回源IP段](/intl.zh-CN/接入WAF/CNAME接入/放行WAF回源IP段.md)。如果您的服务器未使用其他防火墙服务，则无需配置。

        单击**完成，返回网站列表**，返回网站接入页面。


## 后续步骤

完成域名接入流程后，网站访问流量将经过Web应用防火墙保护，您还可以完善网站防护配置，更好地防护网站安全。

Web应用防火墙包含多种防护检测模块，帮助网站应对不同类型的安全威胁，其中**正则防护引擎**和**CC安全防护**模块默认开启，分别用于防御常见的Web应用攻击（例如SQL注入、XSS跨站、webshell上传等）和CC攻击，其他防护模块需要您手动开启并配置具体防护规则。更多信息，请参见[网站防护配置概述](/intl.zh-CN/网站防护配置/概述.md)。

## 上传HTTPS证书

如果您添加的网站信息的**协议类型**中包含**HTTPS**，您必须在Web应用防火墙控制台上传与该网站域名关联的HTTPS证书，且证书必须正确、有效，才能保证Web应用防火墙正常防护网站的HTTPS协议访问请求。

上传HTTPS证书支持以下方式：

-   手动上传证书：您需要提前准备好网站的证书文件和私钥文件。

    需要准备的证书相关内容如下：

    -   \*.crt（公钥文件）或\*.pem（证书文件）
    -   \*.key（私钥文件）
-   选择已有证书：您可以直接从[阿里云SSL证书服务](/intl.zh-CN/产品简介/什么是阿里云SSL证书.md)已有证书中选择与域名关联的证书。

**操作步骤**

1.  登录[Web应用防火墙控制台](https://yundun.console.aliyun.com/?p=waf)。

2.  在顶部菜单栏，选择Web应用防火墙实例的资源组和地域（**中国内地**、**海外地区**）。

3.  在左侧导航栏，单击**资产中心** \> **网站接入**。

4.  在**网站接入**页面，定位到要操作的域名，单击其**协议状态**列**HTTPS**后的![上传图标](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p31794.png)图标。

    **说明：** 只有在添加域名时选择了HTTPS协议类型，**协议状态**下才会出现**HTTPS**。

    ![HTTPS协议状态](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p31793.png)

    HTTPS协议状态异常表示添加域名后未上传证书或上传的证书无效，例如证书格式不正确、证书与当前域名不匹配等。只有在Web应用防火墙上传了合法、有效的证书后，HTTPS协议状态才会显示正常。

5.  在**上传证书**（或**更新证书**）对话框，选择一种**上传方式**上传HTTPS证书。

    **说明：** 如果您已经上传过证书，则显示**更新证书**对话框。**更新证书**对话框中的配置内容和**上传证书**对话框一致。

    -   **手动上传**：填写**证书名称**，并将与域名关联的证书文件和私钥文件的文本内容分别复制粘贴到**证书文件**和**私钥文件**。

        ![手动上传](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p31796.png)

        关于**证书文件**的说明如下：

        -   如果证书是PEM、CER、CRT格式，您可以使用文本编辑器直接打开证书文件并复制其中的文本内容。
        -   如果证书是除PEM、CER、CRT外的其他格式，例如PFX、P7B等，您需要将证书文件转换成PEM格式后，才可以使用文本编辑器打开并复制其中的文本内容。 关于证书格式的转换方法，请参见[HTTPS证书转换成PEM格式]()。
        -   如果域名关联了多个证书文件，例如存在证书链，您需要将证书文件中的文本内容拼接合并后粘贴到**证书文件**。
    -   **选择已有证书**：从**证书**列表选择要上传的证书。

        ![选择已有证书](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p31795.png)

        **证书**列表罗列了SSL证书服务中已签发的证书，您可以从列表中选择与当前域名关联的证书。单击**云盾-证书服务**，可以跳转到SSL证书管理控制台管理证书。

    -   **申请新证书**：单击**立即申请**，跳转到SSL证书申请页面为域名快速申请证书。

        ![申请新证书](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p99119.png)

        按照页面提示为域名配置证书后，已配置证书将默认上传到Web应用防火墙。

        **说明：** 快速申请证书仅支持申请收费型DV证书。如果您需要申请其他类型的证书，请前往SSL证书购买页面进行操作。更多信息，请参见[证书选型和购买](/intl.zh-CN/.md)。

6.  单击**确定**。

    成功上传正确、有效的证书后，HTTPS协议状态将会显示**正常**。

    ![HTTPS协议状态正常](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1935649951/p99223.png)


## 相关操作

成功添加域名后，您可以在**网站接入**页面的域名列表中查看已接入的域名并根据需要执行以下操作：

![域名列表-国际站](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2935649951/p129598.png)

-   检测DNS解析状态：只有当域名DNS已解析到Web应用防火墙的CNAME地址且Web应用防火墙检测到域名的访问流量，**DNS解析状态**才显示**正常**。如果**DNS解析状态**显示**异常**，您可以单击![DNS解析状态异常](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2935649951/p97137.png)查询异常原因。修复异常后，单击![重新检测](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2935649951/p97138.png)重新检测。

    更多信息，请参见[DNS解析状态异常](/intl.zh-CN/常见问题/DNS解析状态异常.md)。

-   上传HTTPS证书：如果网站支持HTTPS协议，请务必确保在Web应用防火墙上传正确的证书和私钥，保证正常防护HTTPS业务流量。您可以单击HTTPS协议状态后![上传](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2935649951/p97136.png)上传域名的HTTPS证书和私钥。

    更多信息，请参见[上传HTTPS证书](#section_jo2_hwu_mbj)。

-   开启日志服务：为域名开启日志服务后，Web应用防火墙日志服务将采集网站的全量日志，支持用作查询分析、仪表盘展示、设置告警等功能。

    更多信息，请参见[开启日志采集](/intl.zh-CN/日志管理/日志服务/开启日志采集.md)。

    **说明：** 日志服务是Web应用防火墙提供的增值服务，必须开通后才能使用。更多信息，请参见[开启WAF日志服务](/intl.zh-CN/日志管理/日志服务/开启WAF日志服务.md)。

-   设置防护资源：单击**防护资源**列下的![设置防护资源](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/2935649951/p97139.png)为域名设置防护资源。

    支持的防护资源类型：

    -   **共享集群共享IP**

        **说明：** 自动添加的网站默认使用**共享集群共享IP**防护资源。

    -   **共享集群独享IP**：请参见[域名独享资源包](/intl.zh-CN/产品定价/开通WAF/域名独享资源包.md)。
    -   **共享集群全局负载均衡防护**：请参见[智能负载均衡接入能力](/intl.zh-CN/产品定价/开通WAF/智能负载均衡接入能力.md)。
    -   **独享集群**：请参见[设置独享集群](/intl.zh-CN/系统管理/设置独享集群.md)。
-   查看攻击监控报表：单击**攻击监控**列下的**查看报表**，跳转到**安全报表**页面，查看域名的防护报表。更多信息，请参见[查看安全报表](/intl.zh-CN/.md)。
-   设置防护策略：单击操作列下的**防护配置**，跳转到**网站防护**页面，设置**Web安全**、**Bot管理**、**访问控制/限流**防护模块的防护策略。更多信息，请参见[设置正则防护引擎](/intl.zh-CN/网站防护配置/Web安全/设置正则防护引擎.md)。
-   编辑域名：单击操作列下的**编辑**修改网站信息，例如协议类型、服务器地址、服务器端口等。不支持修改域名。
-   删除域名：单击操作列下的**删除**删除域名。

    **警告：** 在删除域名前，请将域名DNS解析回服务器源站IP。否则在删除域名后，域名的流量将无法正常转发。


## 相关问题

跨账号迁移网站配置时需要注意什么？

为了防止网站配置迁移误操作导致业务流量转发出现问题，在您删除网站配置后，有一段时间的域名保护期。如果您需要将Web应用防火墙的网站配置迁移到另一个账号下，在原账号中删除网站配置后，您需要等待30分钟后才能在另一个账号的Web应用防火墙实例中添加该域名的网站配置。

如果您需要快速添加该网站配置，请提交[工单](https://workorder-intl.console.aliyun.com/?#/ticket/add/?productId=80)或在钉钉服务群中申请解除该域名的保护期。待保护期解除后，您就可以在新的账号中添加该域名的网站配置。

